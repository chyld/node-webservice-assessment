/* API Endpoints
 *
 * GET  /
 * GET  /users
 * POST /users
 * GET  /stocks/quote
 *
*/

const express = require('express');
const bodyParser = require('body-parser');
const mysql = require('mysql');
const yahoo = require('yahoo-stocks');

const app = express();
app.use(bodyParser.json());
const port = process.env.PORT || 3000;

const pool = mysql.createPool({
    connectionLimit : 10,
    host     : 'localhost',
    user     : 'root',
    password : 'root',
    database : 'finance'
});

// ------------------------------------------------------------------------------------------------------------------------------ //
// ------------------------------------------------------------------------------------------------------------------------------ //
// ------------------------------------------------------------------------------------------------------------------------------ //
// http :8080
app.get('/', (req, res) => res.send('Hello World!'));

// ------------------------------------------------------------------------------------------------------------------------------ //
// ------------------------------------------------------------------------------------------------------------------------------ //
// ------------------------------------------------------------------------------------------------------------------------------ //
// http :8080/users
app.get('/users', (req, res) => {
    pool.getConnection(function(err, connection) {
        if (err) throw err;
        connection.query('select * from users', [], (err, results, fields) => {
            if (err) throw err;
            connection.release();
            res.json({users: results} );
        });
    });
});

// ------------------------------------------------------------------------------------------------------------------------------ //
// ------------------------------------------------------------------------------------------------------------------------------ //
// ------------------------------------------------------------------------------------------------------------------------------ //
// http post :8080/users username=chyld cash:=30.33
app.post('/users', (req, res) => {
    pool.getConnection(function(err, connection) {
        if (err) throw err;
        // check for duplicate users before inserting
        connection.query('insert into users (username, cash) values (?, ?)', [req.body.username, req.body.cash], (err, results, fields) => {
            if (err) throw err;
            connection.release();
            res.json({id: results.insertId, ...req.body} );
        });
    });
});

// ------------------------------------------------------------------------------------------------------------------------------ //
// ------------------------------------------------------------------------------------------------------------------------------ //
// ------------------------------------------------------------------------------------------------------------------------------ //
// http :8080/stocks/quote/goog
app.get('/stocks/quote/:symbol', (req, res) => {
    const symbol = req.params.symbol.toUpperCase()
    yahoo.lookup(symbol).then(data => {
        res.json(data);
    }); 
});

// ------------------------------------------------------------------------------------------------------------------------------ //
// ------------------------------------------------------------------------------------------------------------------------------ //
// ------------------------------------------------------------------------------------------------------------------------------ //

app.listen(port, () => console.log(`Example app listening on port ${port}!`));
